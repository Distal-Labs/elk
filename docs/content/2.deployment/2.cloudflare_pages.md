# Deploying Elk to Cloudflare Pages

## Prerequisites
- A Cloudflare account is required. The _Free_ Tier has the necessary features to support Elk deployment to Cloudflare Pages. Once you have a Cloudflare account set up, you will need to:
  - Create a Cloudflare KV Namespace. Make a note of the namespace `id`, which you'll need to configure your build.
  - Generate a Cloudflare API token with read/write privileges to the KV Namespace you just created.
- Cloudflare `wrangler` is optional but highly recommended; the rest of this guide assumes that `wrangler` is being used
  - Please see [Cloudflare's documentation](https://developers.cloudflare.com/workers/wrangler/install-and-update/) for `wrangler` installation instructions
  - If you decide against using `wrangler`, you'll need to follow Cloudflare's instructions to set up your project and possibly also to perform [Direct Uploads](https://developers.cloudflare.com/pages/platform/direct-upload/) (depending on your workflow preferences)

## Instructions
### Create a fork

Start by [creating a fork](https://github.com/elk-zone/elk/fork) of the Elk GitHub repository. Then, from your command line, change the working directory to the local folder containing the forked repository:
```sh
cd <PATH_TO_THE_LOCAL_CLONE_OF_THE_ELK_REPO>
```
<BR>

### Configure deployment parameters
However you go about it, these parameters must be set at build time. You must complete this step _**before**_ building Elk. 

Build parameter | Example | Description
:-------------- | :------ | :----------
`NUXT_DEPLOY_URL` | https://elk.zone | The public URL for the Elk landing page
`NUXT_PUBLIC_DEFAULT_SERVER` | m.webtoo.ls | The fully-qualified domain name (FQDN) of the Mastodon server whose public timeline will be shown by default when a web browser navigates to `NUXT_DEPLOY_URL`
`NUXT_CLOUDFLARE_ACCOUNT_ID` | xxxxxxxxxxx | Self-explanatory. It should go without saying, but don't pass this value as cleartext and exclude any files that include this value from GitHub commits by adding such files to `.gitignore`
`NUXT_CLOUDFLARE_NAMESPACE_ID` | xxxxxxxxxxx | Note that this parameter takes the _ID_ not the _Name_ of the namespace. You can find the _ID_ of your namespace from your Cloudflare Dashboard. As above ^^, keep this value out of public commits.
`NUXT_CLOUDFLARE_API_TOKEN` | xxxxxxxxxxx | Self-explanatory. You can find the _ID_ of your namespace from your Cloudflare Dashboard. As above ^^, keep this value out of public commits.
`NUXT_STORAGE_DRIVER` | cloudflare | The value here *has to be `cloudflare`, there is no `fs` (filesystem) option when deploying to Cloudflare.

#### Configuration via `.env` file
The most straightforward (but least secure) method of setting the deployment parameters is to create an `.env` file in the working directory of the repository. See `.env.example` for an example with proper formatting.

#### Configuration via GitHub Actions/Repository/Organization
The more secure method of setting the deployment parameters is to set the parameters as variables and secrets that are passed to your GitHub Actions build runner. The variables and secrets that need to be configured for GitHub Actions are listed at the top of the `.github/workflows/cloudflare_pages.yml` file in this repository. NOTE: you do *NOT* need to specify `GITHUB_TOKEN` that is passed to your GitHub Actions build runner automatically by GitHub.

> :bulb: **NOTE:** If you are using GitHub Actions or another continuous integration/continuous deployment framework, you can skip the **Build** and **Publish** sections.

### Build

Build Elk by running the following command:
```sh
npx pnpm i && pnpm run build
```
If the build is successful, `.nuxt` and `.output` folders will be created. For the purposes of Cloudflare Pages, we only care about the `.output/public` folder.

### Publish

Use `wrangler` to create the Cloudflare Pages project. In this example, the project is named `elk` but you can replace that value with whatever you want:
```sh
wrangler pages project create elk
```

<BR>


Now, push the `.output/public` folder to Cloudflare Pages.

```sh
wrangler pages publish .output/public --project-name=elk --branch=release
```

:warning: :eyes: Do **not** upload the `.nuxt/dist` folder to Cloudflare Pages, or you'll end up with a blank landing page. Do **not** upload the entire `.output` folder, or you'll end up with a blank landing page.

<BR>

That's it! You should be able to preview your Elk deployment by visiting the link provided by `wrangler` once the upload has finished
```sh
âœ¨ Deployment complete! Take a peek over at https://xxxxxx.elk-xxx.pages.dev
```

- It is possible, however, to set up a CI/CD pipeline using GitHub Actions, CircleCI, or Travis CI by following the [instructions published by Cloudflare](https://developers.cloudflare.com/pages/how-to/use-direct-upload-with-continuous-integration/).


## Known Issues and Gotchas
- Elk's environment variables need to be passed at build time in order for the deployment to reflect your preferences. This means that you need to include a valid `.env` file or configure your GitHub Action environment variables (use secrets!) to pass the following parameters _before_ building Elk:
  - `NUXT_DEPLOY_URL`
  - `NUXT_PUBLIC_DEFAULT_SERVER`
  - `NUXT_CLOUDFLARE_ACCOUNT_ID`
  - `NUXT_CLOUDFLARE_NAMESPACE_ID`
  - `NUXT_CLOUDFLARE_API_TOKEN`
  - `NUXT_STORAGE_DRIVER=cloudflare`
  
  If you don't pass these parameters at build time, the build will succeed, but your Elk deployment will have nowhere to store user credentials (KV store is necessary), and it will point to the `webtoo.ls` Mastodon host by default.

- An end-to-end CI/CD pipeline using Cloudflare Pages's GitHub integration is not possible at this time due to the following issues specific to Cloudflare Pages:
  - Cloudflare Pages uses outdated build images that [lack support for Node.js >= v17.x](https://developers.cloudflare.com/pages/platform/build-configuration/). After spending several hours on Cloudflare Community and Cloudflare Discord, it's clear that there are no known workarounds. Cloudflare representatives on Discord point to a forthcoming update to their build image library, but offer no specific date of release. As this has been a known issue for 6+ months, it stands to reason that Cloudflare will release updated build images sometime in Q1 2023 but that's just an educated guess.
  - Cloudflare Pages build images also lack built-in support for `pnpm`, but there is a [known workaround](https://community.cloudflare.com/t/add-pnpm-to-pre-installed-cloudflare-pages-tools/288514/3). Even after Cloudflare (eventually) updates its build images, this workaround may (or may not) be necessary, so it is being documented here for posterity.
